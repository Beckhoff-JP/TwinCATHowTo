概要
==============================================

TwinCAT上で制御するモーションデバイスの稼働状態を監視するには、Scope viewというソフトウェアが必要です。
このソフトウェアでは、モーションに対する様々なデータの時系列データを可視化し、様々な分析を行うことができます。

.. figure:: image/TE1300_OPCUA_scope_view.jpg
    :align: center
    :scale: 70%

    TE1300 Scope viewの画面

このソフトウェアで可視化するために収集したデータは、CSVなどの汎用的なファイル形式にエクスポートすることができます。また、PLC、NC、CNCなどのモーションデバイスのメモリ条件 [#f1]_ によって自動的にCSVファイルへ出力することもできます。
本書ではその方法について示します。

.. [#f1] トリガ条件といいます。

必要なライセンス
------------------------

以下のライセンスを有効にしてください。

* XAR側
 
    TC3 Scope View Server ( TF3300 ) 

* XAE側

    TC3 Scope View Professional ( TE1300 ) 

また、外部PCにCSVファイルを保存する場合、IPC側に、接続可能なEthernetポートが一つ必要です。

接続構成（外部PCでCSVファイル保存する場合）
------------------------------------------------

接続構成は、 :numref:`components` の通りとなります。

IPC上で適用されたTF3300により各種PLCデバイスやモーションデータやその状態によるトリガイベントを監視することが可能となります。
また、TE1300により Visual studio 上でのデータのリアルタイムグラフ描画、および、トリガ条件における自動CSVファイル保存が可能となります。

.. figure:: image/connection.png
    :align: center
    :scale: 70%
    :name: components

    TE1300 接続構成例

.. note::
    IPC内にXAEをインストールされている環境の場合、外部PCおよびその接続用Ethernetポートは必要ありません。

全体の流れ
----------

全体の流れは次の手順になります。

1. Scope viewプロジェクトを追加します。
2. モーションやPLCモジュールに接続して、変数をScope view内で使える様にDataPoolに登録します。
3. 登録したDataPoolの変数をYT Chartグラフ上に配置します。
4. DataPoolのフラグや変数の条件により記録を開始したりCSVファイルへ出力するタイミングトリガを設定し、出力するCSVファイルの書式を設定します。

これらの設定がすべて終わったら記録を開始します。

.. image:: image/procedure.png
    :align: center
    :scale: 70%

.. figure:: image/tree_view_structure.png
    :align: center
    :scale: 45%

    Scope view全体の設定項目

本書で紹介するScope viewの機能仕様
------------------------------------

本書では、YT Scope viewプロジェクトを用いて次の機能仕様を実現することを目指します。

* 無限にCSVファイルを出力

  PCのストレージ容量が許す限り無限にCSVファイルを保存します。IPC内で動作させて、ここにCSVを保存する事も可能ですが、容量が無くなる事で制御正常に動作しなくなる要因になります。別のPC上でScope Viewプロジェクトを動作させる運用をおすすめします。

* PLCプログラムにより個別のCSVファイルへ保存

  PLCのプログラムにより生成したトリガ条件でCSVを保存することができます。本書では、直動100mmの連続往復動作のモニタリングを行います。
  この例では、PLCのロジックにより往路の inposition 信号のみを取り出してCSVへデータを保存する例についてご説明します。

* CSVへの記録範囲

  CSVへ保存するトリガは一つだけ定義可能です。そのデータが記録される範囲は、前回トリガが発行されてから今回のトリガ発行タイミングまでの全ての期間のデータとなります。
  記録開始トリガを個別に設定することはできません。

  前回のトリガが発行されてから過大な時間が経過した後にトリガが発生した場合は、 :numref:`section_measurement_project_property` で説明する ``Record Time`` で設定する時間分の最新のデータだけが保存されることとなります。

* CSVファイル名

  CSVファイルの保存先フォルダ名称は指定できますが、CSVファイル名は、 ``Export_*.csv`` という名称で、``*`` 部分は保存されるたびに自動的に加算される番号になります。
  